name: Fetch FlowScan builder‑fills archive

# runs every day at 00:00 UTC
on:
  workflow_dispatch:        # ← this enables the “Run workflow” button
  schedule:
    - cron: '0 0 * * *'

env:
  # one line per builder: BuilderName;BuilderAddress;StartDate(YYYY-MM-DD)
  BUILDERS: |
    pvp_dot_trade;0x0cbf655b0d22ae71fba3a674b0e1c0c7e7f975af;2024-10-27
  #  BuilderB;0xab29499b6b4da18e26bfd10a053b0cd3ea0f1814;2025-01-01

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Fetch missing JSONs for each builder
        run: |
          DATE_YEST=$(date -d "yesterday" +%Y-%m-%d)

          while IFS=';' read -r NAME ADDR START_DATE; do
            echo "→ $NAME ($ADDR) from $START_DATE → $DATE_YEST"
            mkdir -p data/$NAME

            # ensure failed_dates.json exists
            FAIL_FILE="data/$NAME/failed_dates.json"
            if [ ! -f "$FAIL_FILE" ]; then
              echo '[]' > "$FAIL_FILE"
            fi

            current="$START_DATE"
            while [ "$(date -d "$current" +%Y-%m-%d)" != \
                  "$(date -d "$DATE_YEST + 1 day" +%Y-%m-%d)" ]; do
              DS=$(date -d "$current" +%Y%m%d)
              OUTFILE="data/$NAME/$DS.json"

              if [ -f "$OUTFILE" ]; then
                echo "   • skip $DS (already have it)"
              else
                echo "   • fetch $DS"
                RAW=$(curl -s "https://www.flowscan.xyz/api/builder-fills?builderAddress=$ADDR&date=$DS")

                # detect error key
                if echo "$RAW" | jq 'has("error")' | grep -q true; then
                  echo "     ⚠️ error for $DS – logging"
                  # append to failed_dates.json if not already there
                  tmp=$(mktemp)
                  jq --arg d "$DS" \
                     'if index($d)==null then . + [$d] else . end' \
                     "$FAIL_FILE" > "$tmp" && mv "$tmp" "$FAIL_FILE"
                else
                  # valid payload → write it
                  echo "$RAW" > "$OUTFILE"
                fi
              fi

              current=$(date -d "$current + 1 day" +%Y-%m-%d)
            done
          done <<< "$BUILDERS"


      - name: Commit new data files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data
          git diff --quiet --cached || (
            git commit -m "Add missing builder‑fills for $(date -d "yesterday" +%Y%m%d)"
            git push
          )
