name: Debug FlowScan Fetch

on:
  workflow_dispatch:

jobs:
  debug-fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug download loop for liquid_perps
        run: |
          set -ex

          # hard‚Äëcode the builder you want to debug
          NAME=liquid_perps
          ADDR='0x6d4e7f472e6a491b98cbeed327417e310ae8ce48'
          START_DATE='2025-06-22'
          YEST=$(date -d "yesterday" +%Y-%m-%d)

          echo "üõ†Ô∏è  Debugging $NAME from $START_DATE through $YEST‚Ä¶"

          current="$START_DATE"
          while [ "$(date -d "$current" +%Y-%m-%d)" != "$(date -d "$YEST + 1 day" +%Y-%m-%d)" ]; do
            D=$(date -d "$current" +%Y%m%d)
            echo
            echo "‚Üí Fetching $D"
            RAW=$(curl -v -s "https://www.flowscan.xyz/api/builder-fills?builderAddress=$ADDR&date=$D" || true)
            echo "raw length = ${#RAW}"
            echo "raw preview:"
            echo "${RAW:0:200}"
            echo

            # test JSON validity
            if echo "$RAW" | jq . >/dev/null 2>&1; then
              echo "‚ûî Valid JSON"
              if echo "$RAW" | jq -e 'has("error")' >/dev/null 2>&1; then
                echo "‚ö†Ô∏è  Contains an error field: $(echo $RAW | jq -r .error)"
              else
                echo "‚úÖ  Good data, revenue=$(echo $RAW | jq .revenue)"
              fi
            else
              echo "‚ùå  Not JSON!"
            fi

            current=$(date -d "$current + 1 day" +%Y-%m-%d)
          done

          echo
          echo "üéâ Loop complete."
