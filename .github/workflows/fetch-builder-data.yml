name: Debug All FlowScan Fetch

on:
  workflow_dispatch:

jobs:
  debug-all:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false        # keep going even if one builder hiccups
      matrix:
        include:
          - builder: pvp_dot_trade
            addr: '0x0cbf655b0d22ae71fba3a674b0e1c0c7e7f975af'
            start: '2024-10-27'
          - builder: liquid_perps
            addr: '0x6d4e7f472e6a491b98cbeed327417e310ae8ce48'
            start: '2025-06-22'
          - builder: pocket_pro
            addr: '0x7151A036313EEe8Aa9Bc45d0969ca0E1637AAd3C'
            start: '2025-03-23'
          # â€¦add all your builders hereâ€¦

    name: Debug ${{ matrix.builder }}
    steps:
      - uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Debug fetch loop
        run: |
          set -ex
          NAME=${{ matrix.builder }}
          ADDR=${{ matrix.addr }}
          START_DATE=${{ matrix.start }}
          YEST=$(date -d "yesterday" +%Y-%m-%d)

          echo "ğŸ” Builder: $NAME"
          echo "    Address: $ADDR"
          echo "    Start:   $START_DATE â†’ Yesterday: $YEST"

          current="$START_DATE"
          while [ "$(date -d "$current" +%Y-%m-%d)" != "$(date -d "$YEST + 1 day" +%Y-%m-%d)" ]; do
            D=$(date -d "$current" +%Y%m%d)
            echo
            echo "â”€â”€ Date: $D â”€â”€"
            RAW=$(curl -s "https://www.flowscan.xyz/api/builder-fills?builderAddress=$ADDR&date=$D")

            echo "Raw size: ${#RAW} bytes"
            echo "Preview:"
            echo "${RAW:0:200}"

            if echo "$RAW" | jq -e 'has("error")' >/dev/null 2>&1; then
              echo "âŒ  API returned error: $(echo $RAW | jq -r .error)"
            else
              echo "âœ…  OK (revenue=$(echo $RAW | jq -r .revenue))"
            fi

            current=$(date -d "$current + 1 day" +%Y-%m-%d)
          done

          echo
          echo "ğŸ‰ Fetch loop done for $NAME"
