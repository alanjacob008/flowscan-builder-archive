permissions:
  contents: write

name: Fetch FlowScan builder‑fills archive

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  fetch:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - builder: pvp_dot_trade
            addr: 0x0cbf655b0d22ae71fba3a674b0e1c0c7e7f975af
            start: '2024-10-27'
          - builder: liquid_perps
            addr: 0x6d4e7f472e6a491b98cbeed327417e310ae8ce48
            start: '2025-06-22'
          - builder: pocket_pro
            addr: 0x7151A036313EEe8Aa9Bc45d0969ca0E1637AAd3C
            start: '2025-03-23'
          # …add one block per builder…

    name: Fetch ${{ matrix.builder }}
    steps:
      - name: Check out repo
        uses: actions/checkout@v3

      - name: Purge stray JSONs for this builder
        run: rm -f data/${{ matrix.builder }}/*.json

      - name: Ensure error‑log exists
        run: |
          mkdir -p data/${{ matrix.builder }}
          FAIL="data/${{ matrix.builder }}/failed_dates.json"
          [ -f "$FAIL" ] || echo '[]' > "$FAIL"

      - name: Fetch & build for ${{ matrix.builder }}
        run: |
          NAME=${{ matrix.builder }}
          ADDR=${{ matrix.addr }}
          START_DATE=${{ matrix.start }}
          YEST=$(date -d "yesterday" +%Y-%m-%d)
          FAIL_FILE="data/$NAME/failed_dates.json"
          current="$START_DATE"

          # 1) Download per-day JSONs
          while [ "$(date -d "$current" +%Y-%m-%d)" != "$(date -d "$YEST + 1 day" +%Y-%m-%d)" ]; do
            D=$(date -d "$current" +%Y%m%d)
            RAW=$(curl -s "https://www.flowscan.xyz/api/builder-fills?builderAddress=$ADDR&date=$D")
            OUT="data/$NAME/$D.json"

            if echo "$RAW" | jq 'has("error")' | grep -q true; then
              rm -f "$OUT"
              jq --arg d "$D" 'if index($d)==null then . + [$d] else . end' "$FAIL_FILE" > tmp && mv tmp "$FAIL_FILE"
            else
              [ -f "$OUT" ] || echo "$RAW" > "$OUT"
              jq --arg d "$D" 'map(select(. != $d))' "$FAIL_FILE" > tmp && mv tmp "$FAIL_FILE"
            fi

            current=$(date -d "$current + 1 day" +%Y-%m-%d)
          done

          # 2) daily_summary.json
          jq -n '[inputs
            | { date: (input_filename | capture(".*/(?<d>[0-9]{8})\\.json$").d),
                revenue: .revenue,
                volume:  .volume,
                tradecount: .count,
                uniqueusers: .uniqueUsers }
          ]' data/$NAME/[0-9]*.json > data/$NAME/daily_summary.json

          # 3) user_data.json with active_days
          TMP="data/$NAME/_all.json"; echo '[]' > "$TMP"
          for f in data/$NAME/[0-9]*.json; do
            dt=${f##*/}; dt=${dt%.json}
            jq --arg date "$dt" '[(.userAggregations?//[])[] | . + {date:$date}]' "$f" > tmp1
            jq -s '.[0] + .[1]' "$TMP" tmp1 > tmp2 && mv tmp2 "$TMP"
          done
          jq '[.[]] | group_by(.user) | map({
               user_address: .[0].user,
               total_builder_fee_usd: (map(.builder_fee)|add),
               total_volume: (map(.total_volume)|add),
               total_trades: (map(.count)|add),
               active_days: (map(select(.count>0)|.date)|unique|length)
             })' "$TMP" > data/$NAME/user_data.json
          rm tmp1 "$TMP"

          # 4) Split user_data.json if >3 MB
          SIZE=$(stat -c%s data/$NAME/user_data.json)
          if [ "$SIZE" -gt $((3*1024*1024)) ]; then
            TOTAL=$(jq length data/$NAME/user_data.json)
            CHUNK=5000; CNT=1
            while [ $(( (CNT-1)*CHUNK )) -lt $TOTAL ]; do
              S=$(( (CNT-1)*CHUNK )); E=$((S+CHUNK))
              IDX=$(printf "%04d" $CNT)
              jq ".[$S:$E]" data/$NAME/user_data.json > data/$NAME/user_data_$IDX.json
              CNT=$((CNT+1))
            done
            rm data/$NAME/user_data.json
          fi

      - name: Commit ${{ matrix.builder }} data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/${{ matrix.builder }}
          git diff --quiet --cached || \
            (git commit -m "Update ${{ matrix.builder }} for $(date -d 'yesterday' +%Y%m%d)" && git push)
