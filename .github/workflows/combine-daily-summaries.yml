permissions:
  contents: write

name: Combine daily_summary across builders

on:
  schedule:
    - cron: '2 0 * * *'  # daily at 00:02 UTC
  workflow_dispatch:

jobs:
  combine:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Combine all daily_summary.json files
        run: |
          set -e

          OUT_DIR="data/combined"
          OUT_FILE="$OUT_DIR/daily_summary_all.json"

          mkdir -p "$OUT_DIR"
          rm -f "$OUT_FILE"

          TMPDIR=$(mktemp -d)

          echo "🔍 Gathering daily_summary.json files..."

          # Loop through all builder folders
          for ds in data/*/daily_summary.json; do
            [ -f "$ds" ] || continue
            builder=$(basename "$(dirname "$ds")")

            echo "📦 Processing $builder"

            # Append builder field to each entry
            jq --arg b "$builder" '[ .[] | . + { builder: $b } ]' "$ds" > "$TMPDIR/${builder}.json"
          done

          echo "🧩 Combining and sorting..."

          # Merge and sort: date ascending, builder name ascending
          jq -s 'add | sort_by(.date, .builder)' "$TMPDIR"/*.json > "$OUT_FILE"

          rm -rf "$TMPDIR"

      - name: Commit combined file
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git stash push --include-untracked --quiet || true
          git pull --rebase origin main
          git stash pop --quiet || true

          git add data/combined/daily_summary_all.json
          git diff --quiet --cached || \
            (git commit -m "Update combined daily_summary (for $(date -d 'yesterday' +%Y%m%d))" && git push)
